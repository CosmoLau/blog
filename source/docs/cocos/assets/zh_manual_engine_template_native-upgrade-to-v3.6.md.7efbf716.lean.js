import{_ as s,v as a,b as n,R as l}from"./chunks/framework.5ffcbaff.js";const C=JSON.parse('{"title":"v3.5 已构建工程升级 v3.6 指南","description":"","frontmatter":{},"headers":[],"relativePath":"zh/manual/engine/template/native-upgrade-to-v3.6.md","filePath":"zh/manual/engine/template/native-upgrade-to-v3.6.md"}'),o={name:"zh/manual/engine/template/native-upgrade-to-v3.6.md"},e=l(`<h1 id="v3-5-已构建工程升级-v3-6-指南" tabindex="-1">v3.5 已构建工程升级 v3.6 指南 <a class="header-anchor" href="#v3-5-已构建工程升级-v3-6-指南" aria-label="Permalink to &quot;v3.5 已构建工程升级 v3.6 指南&quot;">​</a></h1><p>本文将详细介绍 Cocos Creator 原生构建工程从 3.5.0 ~ 3.5.x 升级到 3.6 的注意事项。修改仅针对项目工程下的 native 目录。</p><h2 id="构建" tabindex="-1">构建 <a class="header-anchor" href="#构建" aria-label="Permalink to &quot;构建&quot;">​</a></h2><p>使用新版本的引擎打开旧版本的工程，待升级完成之后，构建目标平台。为避免升级失败，请先备份好工程，然后依据下列步骤进行升级。</p><h2 id="android-平台" tabindex="-1">Android 平台 <a class="header-anchor" href="#android-平台" aria-label="Permalink to &quot;Android 平台&quot;">​</a></h2><h3 id="文件修改" tabindex="-1">文件修改 <a class="header-anchor" href="#文件修改" aria-label="Permalink to &quot;文件修改&quot;">​</a></h3><ul><li>删除文件：jni/main.cpp</li><li>android/CMakeLists.txt：删除 <code>\${CMAKE_CURRENT_LIST_DIR}/jni/main.cpp</code></li></ul><h3 id="编译修改" tabindex="-1">编译修改 <a class="header-anchor" href="#编译修改" aria-label="Permalink to &quot;编译修改&quot;">​</a></h3><p>为减少包体大小，更改了 <code>CMAKE_C_FLAGS_RELEASE</code>、<code>CMAKE_CXX_FLAGS_RELEASE</code> 编译参数 <code>visibility</code> 的默认值：从 <code>default</code> 改成了 <code>hidden</code>。改完后 arm64-v8a 下的引擎动态库可以减少约 3.5M。针对这个修改，若 release 版本 <code>jni</code> 出现接口找不到，请先检查接口是否有添加 <code>JNIEXPORT</code> 的声明。例如：</p><ul><li><p>旧代码</p><div class="language-cpp"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> Java_com_google_android_games_paddleboat_GameControllerManager_onMouseConnected</span></span></code></pre></div></li><li><p>修改后的代码</p><div class="language-cpp"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">JNIEXPORT </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> JNICALL Java_com_google_android_games_paddleboat_GameControllerManager_onMouseConnected</span></span></code></pre></div></li></ul><h2 id="代码修改" tabindex="-1">代码修改 <a class="header-anchor" href="#代码修改" aria-label="Permalink to &quot;代码修改&quot;">​</a></h2><ul><li><p>有自定义 jsb 接口的工程：须删除与 <code>NonRefNativePtrCreatedByCtorMap</code> 相关的代码</p></li><li><p>JSB 手动绑定的代码需要置空 <code>_finalize</code> 函数, 可参考<a href="./../../advanced-topics/JSB2.0-learning.html#cpp-命名空间namespace">JSB 2.0 绑定教程 C++ 对象的生命周期管理</a>。</p><p>代码示例如下：</p><div class="language-cpp"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">bool</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">js_cc_gfx_Size_finalize</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">se</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">State</span><span style="color:#C792EA;">&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">s</span><span style="color:#89DDFF;">)</span><span style="color:#676E95;font-style:italic;"> // NOLINT(readability-identifier-naming)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">auto</span><span style="color:#A6ACCD;"> iter </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">se</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">NonRefNativePtrCreatedByCtorMap</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">find</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">SE_THIS_OBJECT</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">cc</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">gfx</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Size</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">iter </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">se</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">NonRefNativePtrCreatedByCtorMap</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">end</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#FFCB6B;">se</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">NonRefNativePtrCreatedByCtorMap</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">erase</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">iter</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#C792EA;">auto</span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> cobj </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">SE_THIS_OBJECT</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">cc</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">gfx</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">Size</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#F07178;">s</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">JSB_FREE</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">cobj</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#82AAFF;">SE_BIND_FINALIZE_FUNC</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">js_cc_gfx_Size_finalize</span><span style="color:#89DDFF;">)</span></span></code></pre></div><p>改为</p><div class="language-cpp"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">bool</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">js_cc_gfx_Size_finalize</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">se</span><span style="color:#89DDFF;">::</span><span style="color:#FFCB6B;">State</span><span style="color:#C792EA;">&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">s</span><span style="color:#89DDFF;">)</span><span style="color:#676E95;font-style:italic;"> // NOLINT(readability-identifier-naming)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#82AAFF;">SE_BIND_FINALIZE_FUNC</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">js_cc_gfx_Size_finalize</span><span style="color:#89DDFF;">)</span></span></code></pre></div></li></ul><h2 id="脚本编写注意事项" tabindex="-1">脚本编写注意事项 <a class="header-anchor" href="#脚本编写注意事项" aria-label="Permalink to &quot;脚本编写注意事项&quot;">​</a></h2><p>由于 Native 引擎的实现和非 Native 的引擎在实现上略有差异，开发者须了解这些差异，现整理如下：</p><ul><li><p><code>Readonly</code>：在 Native 平台上，为减少内存使用，获取到的属性是新创建的对象。</p><p>关于 <code>Readonly</code> 的说明可参考 <a href="./../../scripting/readonly.html#readonly">开发注意事项 - ReaOnly</a></p></li></ul>`,15),p=[e];function t(c,r,i,F,y,D){return a(),n("div",null,p)}const A=s(o,[["render",t]]);export{C as __pageData,A as default};
