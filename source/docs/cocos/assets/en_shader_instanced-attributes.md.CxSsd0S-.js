import{_ as s,c as i,o as a,a4 as e}from"./chunks/framework.uQk9_EO2.js";const g=JSON.parse('{"title":"Instanced Attributes","description":"","frontmatter":{},"headers":[],"relativePath":"en/shader/instanced-attributes.md","filePath":"en/shader/instanced-attributes.md","lastUpdated":1712305443000}'),t={name:"en/shader/instanced-attributes.md"},n=e(`<h1 id="instanced-attributes" tabindex="-1">Instanced Attributes <a class="header-anchor" href="#instanced-attributes" aria-label="Permalink to &quot;Instanced Attributes&quot;">​</a></h1><p>The GPU Instancing feature allows for GPU instancing of render objects with the same mesh and material. If we want to modify the visual effect for one of the instanced objects without breaking this feature, we need to add instanced attributes.</p><p>Let&#39;s take adding a color property as an example.</p><h2 id="add-attribute" tabindex="-1">Add Attribute <a class="header-anchor" href="#add-attribute" aria-label="Permalink to &quot;Add Attribute&quot;">​</a></h2><p>GPU Instancing need to add new attributes and they should be placed within the <code>USE_INSTANCING</code> macro to avoid compilation errors.</p><div class="language-glsl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">glsl</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#if</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> USE_INSTANCING</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // when instancing is enabled</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  #</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pragma</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RGBA8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // normalized unsigned byte</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  in</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vec4</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> a_instanced_color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#endif</span></span></code></pre></div><h2 id="passing-to-fs" tabindex="-1">Passing to FS <a class="header-anchor" href="#passing-to-fs" aria-label="Permalink to &quot;Passing to FS&quot;">​</a></h2><p>The instanced attributes are vertex attributes and can only be accessed in the vertex shader, and the <code>a_instanced_color</code> is only used to modify the object&#39;s color in the fragment shader. Therefore, we need to declare an <code>out</code> variable in the vertex shader that will be used to pass attributes to the fragment shader. Here&#39;s an example of the code.</p><div class="language-glsl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">glsl</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CCProgram vs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  #if</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> USE_INSTANCING</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    out vec4 instancedColor;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  #endif</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  vec4 </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      #if</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> USE_INSTANCING</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        instancedColor </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a_instanced_color;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      #endif</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span></span></code></pre></div><h2 id="access-in-fs" tabindex="-1">Access in FS <a class="header-anchor" href="#access-in-fs" aria-label="Permalink to &quot;Access in FS&quot;">​</a></h2><p>To achieve the desired functionality, declare the corresponding <code>in</code> variable in the fragment shader to retrieve the value passed from the vertex shader.</p><div class="language-glsl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">glsl</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CCProgram fs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  #if</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> USE_INSTANCING</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    in vec4 instancedColor;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  #endif</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  vec4 </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">frag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      vec4 o </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mainColor;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      #if</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> USE_INSTANCING</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        o </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> instancedColor;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      #endif</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">%</span></span></code></pre></div><h2 id="set-instanced-attribute-in-script" tabindex="-1">Set Instanced Attribute in Script <a class="header-anchor" href="#set-instanced-attribute-in-script" aria-label="Permalink to &quot;Set Instanced Attribute in Script&quot;">​</a></h2><p>Instanced Attributes belong to specific instances of render objects and cannot be set through the material panel. Instead, they can be set using the <code>setInstancedAttribute</code> method on the <code>MeshRenderer</code> component. Here&#39;s an example of the code.</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> comp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> node.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getComponent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(MeshRenderer);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">comp.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setInstancedAttribute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;a_instanced_color&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">150</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span></code></pre></div><h2 id="notes" tabindex="-1">Notes <a class="header-anchor" href="#notes" aria-label="Permalink to &quot;Notes&quot;">​</a></h2><p>Here are a few points to keep in mind.</p><ol><li><p><code>#pragma format(RGBA8)</code> is use to specify the specific data format of the property. The parameter can be any enumeration name from the engine&#39;s <code>GFXFormat</code>[^1]. If not specified, it defaults to the RGBA32F type.</p></li><li><p>All instanced attributes are input through the vertex attributes. If you want to use them in the fragment shader, you need to pass them to the fragment shader from vertex shader using the varying variables(<code>in</code>,<code>out</code>).</p></li><li><p>Ensure that your code can execute correctly in all branches, regardless of whether the <code>USE_INSTANCING</code> is enabled.</p></li><li><p>The values of instanced attributes are initialized to 0 when engine starts.</p></li><li><p>If the material has been changed on <strong>MeshRenderer</strong>, all values of instanced attributes will be reset and need to be set again.</p></li></ol><p>[^1]: Integer attributes are not supported on WebGL-1.0-only platforms. If your project needs to be published on these platforms, always use the floating-point type.</p>`,19),h=[n];function l(p,r,d,k,o,c){return a(),i("div",null,h)}const y=s(t,[["render",l]]);export{g as __pageData,y as default};
